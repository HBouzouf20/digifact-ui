"use strict";(self.webpackChunkavalon_ng=self.webpackChunkavalon_ng||[]).push([[967],{5967:(Ke,A,s)=>{s.r(A),s.d(A,{RepairModule:()=>He});var u=s(6814),c=s(132),N=s(8180),O=s(9397),b=s(9413),m=s(4992),Q=s(2333),e=s(9212),C=s(9567),h=s(3530),V=s(537),q=s(9516),f=s(4611),g=s(707),p=s(6223),v=s(6925);const Y=()=>({width:"70%",height:"40%",padding:"0px"}),S=()=>({"background-color":"#f9f9f9"}),L=()=>({width:"60%",height:"40vh",padding:"0px"});let j=(()=>{class n{constructor(t,a,i,o){this.repairService=t,this.router=a,this.toast=i,this.auth=o,this.loading=!1,this.dataRows=[],this.showDetail=!1,this.rowDetail={},this.showEditStatus=!1,this.user=null,this.status=[{state:"Pending"},{state:"Repared"},{state:"Canceled"}],this.paymentStatus=[{state:"Payed",value:"PAYED"},{state:"Not payed",value:"NOT_PAYED"}],this.items=[],this.repairMapping={id:r=>r.id,reference:r=>r.reference,brand:r=>r.brand.name,product:r=>`${r.productReference}`,client:r=>`<strong>${r.client.phone} -</strong> ${r.client.fullname}`,depositDate:r=>r.depositDate,issues:r=>r.issues,repairStatus:r=>r.status,price:r=>r.price,paymentStatus:r=>r.paymentStatus}}ngOnInit(){this.user=this.auth.getSignedUser(),this.repairService.getAllRepairs().pipe((0,N.q)(1),(0,O.b)(t=>{this.dataRows=t})).subscribe()}onEvent(t,a){if("Add"==t)this.router.navigate(["/repairs/add"]);else if(t.eventType&&"edit"===t.eventType){delete t.eventType;let i=this.dataRows.find(o=>o.id===t.id);this.router.navigate(["/repairs/edit"],{state:{formData:JSON.stringify(i)}})}else t.eventType&&"delete"===t.eventType?(delete t.eventType,this.delete(t)):t.eventType&&"show"===t.eventType?(delete t.eventType,this.showDetail=!0,this.rowDetail=t,this.rep=this.dataRows.find(i=>i.id===t.id),this.items=this.rep.items,this.itemsToShow=JSON.stringify(this.items[0],null,2)):t.eventType&&"editStatus"===t.eventType&&(delete t.eventType,this.editStatus(t))}editStatus(t){this.rep=this.dataRows.find(a=>a.id===t.id),this.payStatus=this.paymentStatus.find(a=>a.value===this.rep.paymentStatus),this.repStatus=this.status.find(a=>a.state===this.rep.status),this.showEditStatus=!0}canAddItem(){return(0,m.F)(this.user,"create:repairs")}canViewItem(){return(0,m.F)(this.user,"view:repairs")}canDeleteItem(){return(0,m.F)(this.user,"delete:repairs")}canUpdateItem(){return(0,m.F)(this.user,"update:repairs")}canEditStatusItem(){return(0,m.F)(this.user,"editStatus:repairs")}saveStatus(){this.rep.paymentStatus=this.payStatus.value,this.rep.status=this.repStatus.state,this.repairService.updateRepair(this.rep.id,this.rep).subscribe({next:t=>{this.toast.showSuccess("Repair was updated successfully!"),this.showEditStatus=!1;const a=this.dataRows.findIndex(i=>i.id===this.rep.id);if(-1!==a){const i=this.dataRows;i[a]=this.rep,this.dataRows=[...i]}},error:t=>{this.toast.showError("Failed to update Repair. Please try again.")}})}canSeeDetails(){return(0,m.F)(this.user,"details:repairs")}delete(t){this.repairService.deleteRepair(t.id).subscribe({next:a=>{let i=this.dataRows.findIndex(o=>o.id==t.id);if(-1!==i){let o=this.dataRows.splice(i,1);this.dataRows=this.dataRows.filter(r=>r.id!==o[0].id)}},error:a=>{console.error("Error adding repair:",a)}})}static{this.\u0275fac=function(a){return new(a||n)(e.Y36(b.Z),e.Y36(c.F0),e.Y36(C.k),e.Y36(Q.e))}}static{this.\u0275cmp=e.Xpm({type:n,selectors:[["app-repair"]],decls:20,vars:45,consts:[[3,"visibleChange","modal","header","draggable","visible","contentStyle","styleClass","closeOnEscape","dismissableMask","resizable"],[3,"values","disableAll"],[1,"modal"],[1,"col-12","flex"],[1,"col-6"],["htmlFor","status"],["optionLabel","state","placeholder","Select Status",3,"ngModelChange","ngModel","options"],["htmlFor","paymentStatus"],["pButton","","pRipple","",1,"p-button-primary","save","border-round",3,"click","label"],[1,"grid"],[1,"col-12"],[1,"card"],["name","repair",3,"event","paginate","canAddItem","deletable","editable","haveDetails","dataRows","mapping","status"]],template:function(a,i){1&a&&(e.TgZ(0,"p-dialog",0),e.ALo(1,"translate"),e.Uc_("visibleChange",function(r){return e.nJJ(i.showDetail,r)||(i.showDetail=r),r}),e._UZ(2,"app-equipment-detail",1),e.qZA(),e.TgZ(3,"p-dialog",0),e.ALo(4,"translate"),e.Uc_("visibleChange",function(r){return e.nJJ(i.showEditStatus,r)||(i.showEditStatus=r),r}),e.TgZ(5,"div",2)(6,"div",3)(7,"div",4)(8,"label",5),e._uU(9,"Reparation Status"),e.qZA(),e.TgZ(10,"p-dropdown",6),e.Uc_("ngModelChange",function(r){return e.nJJ(i.repStatus,r)||(i.repStatus=r),r}),e.qZA()(),e.TgZ(11,"div",4)(12,"label",7),e._uU(13,"Payment Status"),e.qZA(),e.TgZ(14,"p-dropdown",6),e.Uc_("ngModelChange",function(r){return e.nJJ(i.payStatus,r)||(i.payStatus=r),r}),e.qZA()()(),e.TgZ(15,"button",8),e.NdJ("click",function(){return i.saveStatus()}),e.qZA()()(),e.TgZ(16,"div",9)(17,"div",10)(18,"div",11)(19,"generator-table",12),e.NdJ("event",function(r){return i.onEvent(r)}),e.qZA()()()()),2&a&&(e.Akn(e.DdM(41,Y)),e.Q6J("modal",!0)("header",e.lcZ(1,37,"repair.detail"))("draggable",!0),e.E3D("visible",i.showDetail),e.Q6J("contentStyle",e.DdM(42,S))("styleClass","custom-dialog")("closeOnEscape",!0)("dismissableMask",!0)("resizable",!0),e.xp6(2),e.Q6J("values",i.items)("disableAll",!0),e.xp6(),e.Akn(e.DdM(43,L)),e.Q6J("modal",!0)("header",e.lcZ(4,39,"repair.editStatus"))("draggable",!0),e.E3D("visible",i.showEditStatus),e.Q6J("contentStyle",e.DdM(44,S))("styleClass","custom-dialog")("closeOnEscape",!0)("dismissableMask",!0)("resizable",!0),e.xp6(7),e.E3D("ngModel",i.repStatus),e.Q6J("options",i.status),e.xp6(4),e.E3D("ngModel",i.payStatus),e.Q6J("options",i.paymentStatus),e.xp6(),e.Q6J("label","Save"),e.xp6(4),e.Q6J("paginate",!1)("canAddItem",i.canAddItem())("deletable",i.canDeleteItem())("editable",i.canUpdateItem())("haveDetails",i.canSeeDetails())("dataRows",i.dataRows)("mapping",i.repairMapping)("status",i.canEditStatusItem()))},dependencies:[h.V,V.j,q.z,f.Lt,g.Hq,p.JJ,p.On,v.X$],styles:[".drop[_ngcontent-%COMP%]{z-index:1000}label[_ngcontent-%COMP%]{margin-right:8px}  .p-dropdown-panel{z-index:99999}.save[_ngcontent-%COMP%]{margin-top:5%;width:50%;align-self:center}.modal[_ngcontent-%COMP%]{display:flex;flex-direction:column}"]})}}return n})();var y=s(5861),_=s(5993),x=s(5836);class z{constructor(l){this.state="",this.state=l}}class B{constructor(l){this.state="",this.state=l}}var H=s(3630);class G{constructor(l){this.product=new H.hd,this.paymentStatus=new B("Not payed"),this.reference="",this.equipment=[],this.productReference=0,this.brand=0,this.equipmentPrices=new Array,this.client="",this.dateDepot="",this.issue="",this.status=new z("Pending"),this.price=0,Object.assign(this,l)}}var D=s(4036),w=s(5219),K=s(5475),X=s(3839),W=s(6387),E=s.n(W),$=s(7375),ee=s(9731),Z=s(5118),M=s(3714),I=s(2018),F=s(1532),J=s(6804);const te=["barcode"];let ie=(()=>{class n{constructor(){this.date=Date.now(),this.ticket={code:"123456",clientName:"HAMZA Bouzouf",phone:"0493230948",price:"450.00 DH",issues:[""]},this.Date=Date}ngOnChanges(t){t.ticket&&this.ticket&&this.generateBarcode(this.ticket.code)}generateBarcode(t){t&&this.barcodeElement&&E()(this.barcodeElement.nativeElement,t,{format:"CODE128",lineColor:"black",width:1,height:20,displayValue:!1})}static{this.\u0275fac=function(a){return new(a||n)}}static{this.\u0275cmp=e.Xpm({type:n,selectors:[["app-printer"]],viewQuery:function(a,i){if(1&a&&e.Gf(te,7),2&a){let o;e.iGM(o=e.CRH())&&(i.barcodeElement=o.first)}},inputs:{ticket:"ticket"},features:[e.TTD],decls:30,vars:8,consts:[["barcode",""],[1,"ticket"],[1,"ticket-header"],[1,"ticket-item"]],template:function(a,i){1&a&&(e.TgZ(0,"div",1)(1,"div",2),e.O4$(),e._UZ(2,"svg",null,0),e.qZA(),e.kcU(),e.TgZ(4,"div",3)(5,"span"),e._uU(6,"Client Name:"),e.qZA(),e.TgZ(7,"span"),e._uU(8),e.qZA()(),e.TgZ(9,"div",3)(10,"span"),e._uU(11,"Phone:"),e.qZA(),e.TgZ(12,"span"),e._uU(13),e.qZA()(),e.TgZ(14,"div",3)(15,"span"),e._uU(16,"Price:"),e.qZA(),e.TgZ(17,"span"),e._uU(18),e.qZA()(),e.TgZ(19,"div",3)(20,"span"),e._uU(21,"Issues:"),e.qZA(),e.TgZ(22,"span"),e._uU(23),e.qZA()(),e.TgZ(24,"div",3)(25,"span"),e._uU(26,"Date:"),e.qZA(),e.TgZ(27,"span"),e._uU(28),e.ALo(29,"date"),e.qZA()()()),2&a&&(e.xp6(8),e.Oqu(i.ticket.clientName),e.xp6(5),e.Oqu(i.ticket.phone),e.xp6(5),e.hij("",i.ticket.price," DH"),e.xp6(5),e.Oqu(i.ticket.issues),e.xp6(5),e.Oqu(e.xi3(29,5,i.date,"dd-MM-yyyy")))},dependencies:[u.uU],styles:[".ticket[_ngcontent-%COMP%]{padding:10px;border:1px solid #000;box-sizing:border-box;background-color:#f4f4f4;display:flex;flex-direction:column;justify-content:space-between}.ticket-header[_ngcontent-%COMP%]{font-size:16px;font-weight:700;text-align:center}.ticket-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;font-size:14px}.ticket-footer[_ngcontent-%COMP%]{text-align:center;font-size:15px;color:#555}@media print{body[_ngcontent-%COMP%], html[_ngcontent-%COMP%]{margin:0;padding:0}.ticket[_ngcontent-%COMP%]{padding:0}.ticket-footer[_ngcontent-%COMP%]{font-size:10px}.no-print[_ngcontent-%COMP%]{display:none}}"]})}}return n})();var ne=s(4480),ae=s(2349);const re=["barcode"],se=()=>({width:"650px"}),oe=n=>({"background-color":n,color:"white"});function le(n,l){1&n&&(e.TgZ(0,"h5"),e._uU(1,"info.repairs"),e.qZA())}function pe(n,l){if(1&n&&(e.TgZ(0,"h5"),e._uU(1),e.qZA()),2&n){const t=e.oxw();e.xp6(),e.Oqu(t.editMode?t.editTitle:t.title)}}function de(n,l){if(1&n){const t=e.EpF();e.TgZ(0,"p-toggleButton",36),e.NdJ("onChange",function(i){e.CHM(t);const o=e.oxw();return e.KtG(o.changeClient(i))}),e.qZA()}if(2&n){const t=e.oxw();e.Akn(e.VKq(5,oe,t.unknownClient?"#dc3545":"#005125")),e.Q6J("onLabel","Inconnu")("offLabel","Client Connu")("onIcon","pi pi-question-circle")}}function ue(n,l){if(1&n&&e._UZ(0,"app-tag-status",37),2&n){let t;const a=e.oxw();e.Q6J("value",null==(t=a.repair.getRawValue().clientType)?null:t.toLowerCase())}}function ce(n,l){if(1&n&&(e.TgZ(0,"span")(1,"strong"),e._uU(2),e.qZA()()),2&n){const t=l.$implicit;e.xp6(2),e.hij("",t.name," ")}}function me(n,l){if(1&n&&(e.TgZ(0,"span")(1,"strong"),e._uU(2),e.qZA()()),2&n){const t=l.$implicit;e.xp6(2),e.hij("",t.name," ")}}function he(n,l){1&n&&(e.TgZ(0,"div",38),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&n&&(e.xp6(),e.hij(" ",e.lcZ(2,1,"validator.field.required")," "))}function fe(n,l){1&n&&(e.TgZ(0,"div",38),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&n&&(e.xp6(),e.hij(" ",e.lcZ(2,1,"validator.field.required")," "))}function ge(n,l){1&n&&(e.TgZ(0,"div",38),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&n&&(e.xp6(),e.hij(" ",e.lcZ(2,1,"validator.field.required")," "))}function ve(n,l){1&n&&(e.TgZ(0,"div",38),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&n&&(e.xp6(),e.hij(" ",e.lcZ(2,1,"validator.field.required")," "))}function be(n,l){if(1&n&&(e.TgZ(0,"span")(1,"strong"),e._uU(2),e.qZA(),e._uU(3),e.qZA()),2&n){const t=l.$implicit;e.xp6(2),e.hij("",t.phone," - "),e.xp6(),e.hij("",t.fullname," ")}}function Ce(n,l){if(1&n&&(e.TgZ(0,"span")(1,"strong"),e._uU(2),e.qZA(),e._uU(3),e.ALo(4,"uppercase"),e.qZA()),2&n){const t=l.$implicit;e.xp6(2),e.hij("",t.phone," - "),e.xp6(),e.hij("",e.lcZ(4,2,t.fullname)," ")}}function ye(n,l){1&n&&(e.TgZ(0,"div",38),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&n&&(e.xp6(),e.hij(" ",e.lcZ(2,1,"validator.field.required")," "))}function Ze(n,l){if(1&n){const t=e.EpF();e.TgZ(0,"div",6)(1,"label",7),e._uU(2,"Client"),e.qZA(),e.TgZ(3,"div",39)(4,"div",8)(5,"p-dropdown",40),e.ynx(6),e.YNc(7,be,4,2,"ng-template",10)(8,Ce,5,4,"ng-template",11),e.BQk(),e.qZA()(),e.TgZ(9,"p-button",41),e.NdJ("click",function(){e.CHM(t);const i=e.oxw();return e.KtG(i.addClient())}),e.qZA()(),e.YNc(10,ye,3,3,"div",12),e.qZA()}if(2&n){const t=e.oxw();e.xp6(5),e.Q6J("options",t.clients)("filter",!0)("showClear",!0),e.xp6(4),e.Q6J("rounded",!0),e.xp6(),e.Q6J("ngIf",t.hasError("client","required"))}}function Te(n,l){1&n&&(e.TgZ(0,"div",38),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&n&&(e.xp6(),e.hij(" ",e.lcZ(2,1,"validator.field.required")," "))}function Re(n,l){1&n&&(e.TgZ(0,"div",38),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&n&&(e.xp6(),e.hij(" ",e.lcZ(2,1,"validator.field.required")," "))}function Ae(n,l){if(1&n&&(e.TgZ(0,"div",6)(1,"label",42),e._uU(2,"Fullname"),e.qZA(),e._UZ(3,"input",43),e.YNc(4,Te,3,3,"div",12),e.qZA(),e.TgZ(5,"div",6)(6,"label",44),e._uU(7,"Phone"),e.qZA(),e._UZ(8,"input",45),e.YNc(9,Re,3,3,"div",12),e.qZA()),2&n){const t=e.oxw();e.xp6(4),e.Q6J("ngIf",t.hasError("fullname","required")),e.xp6(4),e.Q6J("disabled",!0),e.xp6(),e.Q6J("ngIf",t.hasError("phone","required"))}}function qe(n,l){1&n&&(e.TgZ(0,"div",38),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&n&&(e.xp6(),e.hij(" ",e.lcZ(2,1,"validator.field.required")," "))}function Se(n,l){1&n&&(e.TgZ(0,"div",38),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&n&&(e.xp6(),e.hij(" ",e.lcZ(2,1,"validator.field.required")," "))}function _e(n,l){1&n&&(e.TgZ(0,"div",38),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&n&&(e.xp6(),e.hij(" ",e.lcZ(2,1,"validator.field.required")," "))}function xe(n,l){1&n&&(e.TgZ(0,"div",38),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&n&&(e.xp6(),e.hij(" ",e.lcZ(2,1,"validator.min")," 3 "))}function De(n,l){if(1&n){const t=e.EpF();e.TgZ(0,"div",6)(1,"app-equipment-detail",46),e.NdJ("onChange",function(i){e.CHM(t);const o=e.oxw();return e.KtG(o.equipmentPrices(i))}),e.qZA()()}if(2&n){const t=e.oxw();e.xp6(),e.Q6J("disableQte",!0)("disableTitle",!0)("disablePrice",!!t.info)("disableTotal",!0)("isRepair",!0)("equipments",t.getEquipments(t.selectedEquipments))}}function we(n,l){if(1&n){const t=e.EpF();e.TgZ(0,"button",47),e.ALo(1,"translate"),e.NdJ("click",function(){e.CHM(t);const i=e.oxw();return e.KtG(i.addRepair())}),e.qZA()}2&n&&e.Q6J("label",e.lcZ(1,1,"Save"))}function Ee(n,l){1&n&&(e.TgZ(0,"span"),e._uU(1,"Do you want to print ticket?"),e.qZA())}function Me(n,l){if(1&n){const t=e.EpF();e.TgZ(0,"button",48),e.NdJ("click",function(){e.CHM(t);const i=e.oxw();return e.KtG(i.printItemDialog=!1)}),e.qZA(),e.TgZ(1,"button",49),e.NdJ("click",function(){e.CHM(t);const i=e.oxw();return e.KtG(i.printTicket())}),e.qZA()}}let Ie=(()=>{class n{constructor(t,a,i,o,r,d,R,P,Ge){this.brandSerice=t,this.dialogService=a,this.clientService=i,this.fb=o,this.equipmentService=r,this.repairService=d,this.toast=R,this.issueService=P,this.router=Ge,this.clientType=[{state:"Known"},{state:"Unknown"}],this.unknownClient=!1,this.printItemDialog=!1,this.editMode=!1,this.showErrors=!1,this.info=!1,this.formData={},this.editTitle="Edit Repair",this.title="Add Repair",this.paymentStatus=[{state:"Payed",value:"PAYED"},{state:"Not payed",value:"NOT_PAYED"}],this.ticket={code:"",clientName:"",phone:"",price:"",issues:[""]},this.issuesList=[],this.status=[{state:"Pending"},{state:"Repared"},{state:"Canceled"}],this.equipments=[],this.currentClient=new ee.H,this.selectedEquipments=[],this.addEvent=new e.vpe,this.repair=this.fb.group({reference:[this.generateRandom()+""],equipments:[[],p.kI.required],productReference:["",p.kI.required],brand:["",p.kI.required],equipmentPrices:[[],p.kI.required],client:["",p.kI.required],clientType:"",dateDepot:[new Date],issues:["",p.kI.required],status:[{state:"Pending"},p.kI.required],price:["",[p.kI.required,p.kI.min(1)]],paymentStatus:[this.paymentStatus?.value??"NOT_PAYED",p.kI.required],fullname:[""],phone:[""]}),this.router.getCurrentNavigation()?.extras.state&&(this.state=this.router.getCurrentNavigation()?.extras.state)}ngOnChanges(t){this.info&&0!==Object.keys(this.formData).length&&(this.brands||this.initData(),this.updateFormValue(),this.enableReference({value:this.formData.brand.id}),this.repair.patchValue({equipments:this.formData.items.map(a=>a.equipment.id)}),this.repair.get("fullname")?.disable(),this.repair.get("phone")?.disable(),this.repair.get("productReference")?.disable(),this.repair.get("equipments")?.disable(),this.repair.get("brand")?.disable(),this.repair.get("client")?.disable(),this.repair.get("issues")?.disable(),this.repair.get("paymentStatus")?.disable(),this.repair.get("status")?.disable(),this.repair.get("price")?.disable())}printTicket(){const t=document.querySelector(".ticket")?.innerHTML,a=document.createElement("iframe");a.style.position="absolute",a.style.width="0px",a.style.height="0px",a.style.border="none",document.body.appendChild(a);const i=a.contentWindow?.document;i?.open(),i?.write(`\n          <html>\n            <head>\n              <title>Print Ticket</title>\n              <style>\n                @page {\n                  size: 1.25in 1in;\n                  margin: 0;\n                  padding: 0;\n                }\n\n                body {\n                  font-family: Arial, sans-serif;\n                  margin: 0;\n                  padding: 0;\n                }\n\n                .ticket {\n                  padding: 0px;\n                  border: none;\n                  box-sizing: border-box;\n                  background-color: #fff;\n                  display: flex;\n                  flex-direction: column;\n                  justify-content: space-between;\n                }\n\n                .ticket-header {\n                  font-weight: bold;\n                  text-align: center;\n                  font-size: 14px;\n                }\n\n                .ticket-item {\n                  display: flex;\n                  justify-content: space-between;\n                  font-size: 10px;\n                }\n\n                .ticket-footer {\n                  display: none;\n                }\n\n                @media print {\n                  body, html {\n                    width: 1in;\n                    height: 1.25in;\n                    font-size: 10px;\n                    transform: rotate(135deg);\n                    margin: 0;\n                    padding: 0;\n                  }\n\n                  .ticket {\n                    background: green;\n                    margin-right: 0;\n                    font-size: 4px;\n                    padding: 0;\n                  }\n\n                  .no-print {\n                    display: none;\n                  }\n\n                  title {\n                    display: none;\n                  }\n\n                  .ticket-footer {\n                    display: none;\n                  }\n                }\n              </style>\n            </head>\n            <body>\n              <div class="ticket">\n                ${t}\n              </div>\n            </body>\n          </html>\n        `),i?.close(),a.contentWindow?.print(),document.body.removeChild(a)}changeClient(t){this.unknownClient=t.checked,this.unknownClient?(this.repair.get("client")?.clearValidators(),this.repair.get("client")?.updateValueAndValidity(),this.repair.get("fullname")?.setValidators(p.kI.required),this.repair.get("fullname")?.updateValueAndValidity(),this.repair.get("phone")?.setValidators(p.kI.required),this.repair.get("phone")?.updateValueAndValidity()):(this.repair.get("client")?.setValidators(p.kI.required),this.repair.get("client")?.updateValueAndValidity(),this.repair.get("fullname")?.clearValidators(),this.repair.get("fullname")?.updateValueAndValidity(),this.repair.get("phone")?.clearValidators(),this.repair.get("phone")?.updateValueAndValidity())}updateFormValue(){this.unknownClient="Known"!==this.formData.client.type,this.repair.patchValue({productReference:this.formData.productReference,reference:this.formData.reference,dateDepot:new Date(this.formData.depositDate),issues:this.formData.issues,price:this.formData.price,client:this.formData.client.id,clientType:this.formData.client.type,phone:this.formData.client.phone,fullname:this.formData.client.fullname,brand:this.formData.brand.id,paymentStatus:this.paymentStatus.find(t=>t.value===this.formData.paymentStatus),status:this.status.find(t=>t.state===this.formData.status)})}ngAfterViewInit(){0!==Object.keys(this.formData).length&&!this.info&&(this.updateFormValue(),this.editMode=!0,this.editMode&&(this.repair.get("fullname")?.disable(),this.repair.get("phone")?.disable(),this.repair.get("productReference")?.disable(),this.repair.get("equipments")?.disable(),this.repair.get("brand")?.disable(),this.repair.get("client")?.disable()))}ngOnInit(){this.repair.get("dateDepot")?.disable(),this.repair.get("reference")?.disable(),this.repair.get("productReference")?.disable(),this.repair.get("equipments")?.disable(),this.repair.get("paymentStatus")?.setValue(this.paymentStatus[1]),this.repair.get("status")?.setValue(this.status[0]),this.clientService.getAllClients(this.clientType[0].state).subscribe(t=>{this.clients=t}),this.initData(),setTimeout(()=>{const t=this.repair.get("reference")?.value;t&&this.generateBarcode(t)},0)}initData(){this.brandSerice.getAllBrands().subscribe(t=>{this.brands=t,this.editMode&&(this.enableReference({value:this.formData.brand.id}),this.repair.patchValue({equipments:this.formData.items.map(a=>a.equipment.id)}))}),this.issueService.getAllIssues().subscribe(t=>{this.issuesList=t})}equipmentPrices(t){this.repair.patchValue({equipmentPrices:t})}getEquipments(t){return this.equipments.filter(a=>t.includes(a.id))}changeEquipments(t){this.selectedEquipments=t.value}addRepair(){if(!this.repair.valid)return void(this.showErrors=!0);const t=this.repair.getRawValue(),a={id:t.brand||0,name:""};this.currentClient=this.getClient(this.repair);const i=this.transformEquipmentPrices(t.equipmentPrices||[],t.equipments||[]),o={reference:t.reference||"",productReference:t.productReference||"",brand:a,items:i,client:this.currentClient,depositDate:t.dateDepot||"",issues:t.issues||[],status:t.status?.state||"",price:t.price||0,paymentStatus:t.paymentStatus?.value||"Not Payed",...this.editMode&&{id:this.formData.id}};this.ticket={code:this.repair.getRawValue().reference,clientName:this.currentClient.fullname,phone:this.currentClient.phone,price:this.repair.getRawValue().price,issues:this.repair.getRawValue().issues},this.submitRepair(o)}getClient(t){if(t=t.getRawValue(),this.unknownClient)return{id:0,phone:t.phone||"",fullname:t.fullname||"",type:this.clientType[1].state};const a=this.clients.find(i=>i.id===t.client);return{id:0,phone:a?.phone||"",fullname:a?.fullname||"",type:a?.type||""}}transformEquipmentPrices(t,a){return t.map(i=>{const o=a.find(d=>d.sku===i.sku),r=this.editMode?this.formData.items.find(d=>d.equipment.sku===i.sku):null;return{id:this.editMode&&r?.id||"",equipment:{id:o?.id||i.id,sku:o?.sku||i.sku,title:o?.title||i.title},quantity:i.qte,totalPrice:i.total,price:i.price}})}submitRepair(t){(this.editMode?this.repairService.updateRepair(t.id,t):this.repairService.addRepair(t)).subscribe({next:()=>{this.printItemDialog=!0,this.toast.showSuccess(`Repair was ${this.editMode?"updated":"added"} successfully!`)},error:()=>this.toast.showError(`Failed to ${this.editMode?"update":"add"} Repair. Please try again.`)})}syncClient(){this.clientService.getAllClients().subscribe(t=>{this.clients=t})}addClient(){this.ref=this.dialogService.open(K.S,{header:"Add Client",modal:!0,breakpoints:{"960px":"75vw","640px":"90vw"},data:{isModal:!0,onAdd:this.addEvent}}),this.addEvent.subscribe(t=>{this.ref?.close(),this.clients.unshift(t),this.repair.patchValue({client:t.id})})}hasError(t,a){const i=this.repair.get(t);return i?.hasError(a)&&i?.touched||i?.hasError(a)&&this.showErrors}generateRandom(){return Math.floor(1e5+9e5*Math.random())}enableReference(t){this.editMode||this.repair.get("productReference")?.enable(),this.repair.get("equipments")?.enable(),this.selectedEquipments=[];let a=this.brands.find(i=>i.id===t.value).name??this.brands[0].name;this.equipmentService.getProductsByBrand(a).subscribe(i=>{this.equipments=i})}get availableEquipments(){return console.log("availableEquipments ",this.equipments.filter(t=>t.quantity>0)),this.equipments.filter(t=>t.quantity>0)}generateBarcode(t){t&&this.barcodeElement&&E()(this.barcodeElement.nativeElement,t,{format:"CODE128",lineColor:"black",width:2,height:30,displayValue:!0})}static{this.\u0275fac=function(a){return new(a||n)(e.Y36(X.c),e.Y36(Z.xA),e.Y36(x.y),e.Y36(p.qu),e.Y36(_.M),e.Y36(b.Z),e.Y36(C.k),e.Y36($.v),e.Y36(c.F0))}}static{this.\u0275cmp=e.Xpm({type:n,selectors:[["app-repair-form"]],viewQuery:function(a,i){if(1&a&&e.Gf(re,7),2&a){let o;e.iGM(o=e.CRH())&&(i.barcodeElement=o.first)}},inputs:{info:"info",formData:"formData"},features:[e.TTD],decls:72,vars:28,consts:[["barcode",""],[1,"card","col-12","p-fluid"],[1,"flex","items-center","gap-3"],["offIcon","pi pi-calendar-minus","styleClass","w-9rem","ariaLabel","Do you confirm",3,"onLabel","offLabel","onIcon","style"],[3,"formGroup"],[1,"p-formgrid","grid"],[1,"field","col"],["htmlFor","client"],[1,"w-full","mr-2"],["optionValue","id","id","brand","formControlName","brand",3,"onChange","options"],["pTemplate","selectedItem"],["pTemplate","item"],["class","p-error block",4,"ngIf"],["htmlFor","productReference"],["pInputText","","id","productReference","formControlName","productReference","type","text",3,"disabled"],["htmlFor","issue"],["formControlName","issues","optionLabel","label","optionValue","label","placeholder","Select Issue",3,"options"],["For","dateDepot"],["id","dateDepot","dateFormat","dd/mm/yy","formControlName","dateDepot"],["htmlFor","paymentStatus"],["formControlName","paymentStatus","optionLabel","state","placeholder","Select Status",3,"options"],["htmlFor","equipment"],["optionValue","id","id","equipments","formControlName","equipments","optionLabel","title","display","chip",3,"ngModelChange","options","ngModel"],["htmlFor","status"],["formControlName","status","optionLabel","state","placeholder","Select Status",3,"options"],["htmlFor","price"],["pInputText","","id","price","formControlName","price","type","number"],["htmlFor","reference"],["class","field col",4,"ngIf"],["pButton","","pRipple","","class","p-button-primary save border-round",3,"label","click",4,"ngIf"],["header","Confirm",3,"visibleChange","visible","modal"],[1,"flex","align-items-center","justify-content-center"],[1,"pi","pi-exclamation-triangle","mr-3",2,"font-size","2rem"],[4,"ngIf"],[3,"ticket"],["pTemplate","footer"],["offIcon","pi pi-calendar-minus","styleClass","w-9rem","ariaLabel","Do you confirm",3,"onChange","onLabel","offLabel","onIcon"],[3,"value"],[1,"p-error","block"],[1,"flat"],["optionValue","id","id","client","formControlName","client","filterBy","fullname,phone",3,"options","filter","showClear"],["icon","pi pi-plus","severity","primary",3,"click","rounded"],["htmlFor","fullname"],["pInputText","","id","fullname","formControlName","fullname","type","text"],["htmlFor","phone"],["pInputText","","id","phone","formControlName","phone","type","text",3,"disabled"],[3,"onChange","disableQte","disableTitle","disablePrice","disableTotal","isRepair","equipments"],["pButton","","pRipple","",1,"p-button-primary","save","border-round",3,"click","label"],["pButton","","pRipple","","icon","pi pi-times","label","No",1,"p-button-text",3,"click"],["pButton","","pRipple","","icon","pi pi-check","label","Yes",1,"p-button-text",3,"click"]],template:function(a,i){if(1&a){const o=e.EpF();e.TgZ(0,"div",1)(1,"div",2),e.YNc(2,le,2,0,"h5")(3,pe,2,1)(4,de,1,7,"p-toggleButton",3)(5,ue,1,1),e.qZA(),e.TgZ(6,"form",4)(7,"div",5)(8,"div",6)(9,"label",7),e._uU(10,"Brand"),e.qZA(),e.TgZ(11,"div",8)(12,"p-dropdown",9),e.NdJ("onChange",function(d){return e.CHM(o),e.KtG(i.enableReference(d))}),e.ynx(13),e.YNc(14,ce,3,1,"ng-template",10)(15,me,3,1,"ng-template",11),e.BQk(),e.qZA()(),e.YNc(16,he,3,3,"div",12),e.qZA(),e.TgZ(17,"div",6)(18,"label",13),e._uU(19,"Product Reference"),e.qZA(),e._UZ(20,"input",14),e.YNc(21,fe,3,3,"div",12),e.qZA()(),e.TgZ(22,"div",5)(23,"div",6)(24,"label",15),e._uU(25,"Issue"),e.qZA(),e._UZ(26,"p-multiSelect",16),e.YNc(27,ge,3,3,"div",12),e.qZA(),e.TgZ(28,"div",6)(29,"label",17),e._uU(30,"Date d\xe9p\xf4t"),e.qZA(),e._UZ(31,"p-calendar",18),e.YNc(32,ve,3,3,"div",12),e.qZA()(),e.TgZ(33,"div",5),e.YNc(34,Ze,11,5,"div",6)(35,Ae,10,3),e.TgZ(36,"div",6)(37,"label",19),e._uU(38,"Payment Status"),e.qZA(),e._UZ(39,"p-dropdown",20),e.YNc(40,qe,3,3,"div",12),e.qZA()(),e.TgZ(41,"div",5)(42,"div",6)(43,"label",21),e._uU(44,"Equipment"),e.qZA(),e.TgZ(45,"p-multiSelect",22),e.Uc_("ngModelChange",function(d){return e.CHM(o),e.nJJ(i.selectedEquipments,d)||(i.selectedEquipments=d),e.KtG(d)}),e.qZA(),e.YNc(46,Se,3,3,"div",12),e.qZA(),e.TgZ(47,"div",6)(48,"label",23),e._uU(49,"Reparation Status"),e.qZA(),e._UZ(50,"p-dropdown",24),e.qZA()(),e.TgZ(51,"div",5)(52,"div",6)(53,"label",25),e._uU(54,"Price"),e.qZA(),e._UZ(55,"input",26),e.YNc(56,_e,3,3,"div",12)(57,xe,3,3,"div",12),e.qZA(),e.TgZ(58,"div",6)(59,"label",27),e._uU(60,"Reference"),e.qZA(),e.TgZ(61,"div"),e.O4$(),e._UZ(62,"svg",null,0),e.qZA()()(),e.YNc(64,De,2,6,"div",28)(65,we,2,3,"button",29),e.qZA()(),e.kcU(),e.TgZ(66,"p-dialog",30),e.Uc_("visibleChange",function(d){return e.CHM(o),e.nJJ(i.printItemDialog,d)||(i.printItemDialog=d),e.KtG(d)}),e.TgZ(67,"div",31),e._UZ(68,"i",32),e.YNc(69,Ee,2,0,"span",33),e.qZA(),e._UZ(70,"app-printer",34),e.YNc(71,Me,2,0,"ng-template",35),e.qZA()}2&a&&(e.xp6(2),e.um2(2,i.info?2:3),e.xp6(2),e.um2(4,i.editMode||i.info?5:4),e.xp6(2),e.Q6J("formGroup",i.repair),e.xp6(6),e.Q6J("options",i.brands),e.xp6(4),e.Q6J("ngIf",i.hasError("brand","required")),e.xp6(4),e.Q6J("disabled",!0),e.xp6(),e.Q6J("ngIf",i.hasError("productReference","required")),e.xp6(5),e.Q6J("options",i.issuesList),e.xp6(),e.Q6J("ngIf",i.hasError("issues","required")),e.xp6(5),e.Q6J("ngIf",i.hasError("dateDepot","required")),e.xp6(2),e.um2(34,i.unknownClient?35:34),e.xp6(5),e.Q6J("options",i.paymentStatus),e.xp6(),e.Q6J("ngIf",i.hasError("paymentStatus","required")),e.xp6(5),e.Q6J("options",i.availableEquipments),e.E3D("ngModel",i.selectedEquipments),e.xp6(),e.Q6J("ngIf",i.hasError("equipments","required")),e.xp6(4),e.Q6J("options",i.status),e.xp6(6),e.Q6J("ngIf",i.hasError("price","required")),e.xp6(),e.Q6J("ngIf",i.hasError("price","min")),e.xp6(7),e.Q6J("ngIf",i.selectedEquipments.length>0),e.xp6(),e.Q6J("ngIf",!i.info),e.xp6(),e.Akn(e.DdM(27,se)),e.E3D("visible",i.printItemDialog),e.Q6J("modal",!0),e.xp6(3),e.Q6J("ngIf",i.printItemDialog),e.xp6(),e.Q6J("ticket",i.ticket))},dependencies:[u.O5,p._Y,p.Fj,p.wV,p.JJ,p.JL,p.sg,p.u,w.jx,M.o,f.Lt,I.NU,F.f,g.Hq,g.zx,q.z,J.CO,h.V,ie,ne.H,ae.l,u.gd,v.X$],styles:[".flat[_ngcontent-%COMP%]{display:flex;flex-grow:3}.save[_ngcontent-%COMP%]{margin:24px auto 16px;display:block}.danger[_ngcontent-%COMP%]   .p-togglebutton.p-highlight[_ngcontent-%COMP%]{background-color:#dc3545;color:#fff}.danger[_ngcontent-%COMP%]   .p-togglebutton[_ngcontent-%COMP%]{background-color:#005125;color:#f8f8f8}"]})}}return n})(),T=(()=>{class n{constructor(t,a,i,o,r,d,R){this.productService=t,this.clientService=a,this.repairService=i,this.messageService=o,this.route=r,this.router=d,this.toast=R,this.formData={},this.state={},this.editMode=!1,this.isInfo=!1,this.computed=P=>{},this.model=new G,this.services=[{products:this.productService.getAllProducts(),clients:this.clientService.getAllClients()}],this.router.getCurrentNavigation()?.extras.state&&(this.state=this.router.getCurrentNavigation()?.extras.state)}ngOnInit(){this.route.snapshot.url.toString().includes("edit")?this.state.formData?(this.formData=JSON.parse(this.state.formData),this.editMode=!0):this.router.navigate(["/repairs"]):this.route.snapshot.url.toString().includes("info")&&(this.isInfo=!0,this.idRepair=this.route.snapshot.queryParams.id,this.getRepair(this.idRepair))}getRepair(t){this.repairService.getRepairByReference(t).subscribe(a=>{this.formData=a})}addRepair(t){var a=this;return(0,y.Z)(function*(){if(!t)return void a.show("Error","Please provide all required fields for EquipmentDetail !","error");({id:String}).id=t.product,{id:String}.id=t.client;const r={id:a.editMode?t.id:a.generateRandom().toString(),reference:t.reference,product:t.product,client:t.client,depositDate:t.depositDate,issue:t.issue,repairStatus:t.repairStatus,price:t.price,paymentStatus:t.paymentStatus};a.editMode?a.repairService.updateRepair(t.id,r).subscribe({next:d=>{a.toast.showSuccess("Repair was updated successfully!"),a.router.navigate(["/repairs"])},error:d=>{console.error(d),a.toast.showError("Failed to update Repair. Please try again.")}}):a.repairService.addRepair(r).subscribe({next:d=>{a.toast.showSuccess("Repair was added successfully!")},error:d=>{console.error(d),a.toast.showError("Failed to add Repair. Please try again.")}})})()}show(t,a,i){this.messageService.add({severity:i,summary:t,detail:a})}getProduct(t){var a=this;return(0,y.Z)(function*(){return yield(0,D.z)(a.productService.getProductById(t))})()}getClient(t){var a=this;return(0,y.Z)(function*(){return yield(0,D.z)(a.clientService.getClientById(t))})()}generateRandom(){const t=Math.random()*(new Date).getMilliseconds();return Math.floor(t%1e5)}static{this.\u0275fac=function(a){return new(a||n)(e.Y36(_.M),e.Y36(x.y),e.Y36(b.Z),e.Y36(w.ez),e.Y36(c.gz),e.Y36(c.F0),e.Y36(C.k))}}static{this.\u0275cmp=e.Xpm({type:n,selectors:[["app-add-repair"]],decls:2,vars:2,consts:[[1,"col-12"],[3,"formData","info"]],template:function(a,i){1&a&&(e.TgZ(0,"div",0),e._UZ(1,"app-repair-form",1),e.qZA()),2&a&&(e.xp6(),e.Q6J("formData",i.formData)("info",i.isInfo))},dependencies:[Ie],encapsulation:2})}}return n})();const Fe=[{path:"",component:j},{path:"add",data:{breadcrumb:"repair.add"},component:T},{path:"edit",data:{breadcrumb:"repair.edit"},component:T},{path:"info",data:{breadcrumb:"repair.info"},component:T}];let Je=(()=>{class n{static{this.\u0275fac=function(a){return new(a||n)}}static{this.\u0275mod=e.oAB({type:n})}static{this.\u0275inj=e.cJS({imports:[c.Bz.forChild(Fe),c.Bz]})}}return n})();var Ue=s(4956),U=s(4862),ke=s(4104),Pe=s(7830),Ne=s(7327),Oe=s(1480),Qe=s(9663),Ve=s(354),Ye=s(6218),k=s(8952);let Le=(()=>{class n{static{this.\u0275fac=function(a){return new(a||n)}}static{this.\u0275mod=e.oAB({type:n})}static{this.\u0275inj=e.cJS({imports:[u.ez]})}}return n})();var je=s(6634);let ze=(()=>{class n{static{this.\u0275fac=function(a){return new(a||n)}}static{this.\u0275mod=e.oAB({type:n})}static{this.\u0275inj=e.cJS({imports:[u.ez,v.aw,p.UX,Ne.WN,Oe.Gg,f.kW,Qe.zz,Ve.L$,I.q4,Ye.A,M.j,U.X,F._8,Z.DL,k.x,J.KZ,h.S,Le,je.G]})}}return n})();var Be=s(6263);let He=(()=>{class n{static{this.\u0275fac=function(a){return new(a||n)}}static{this.\u0275mod=e.oAB({type:n})}static{this.\u0275inj=e.cJS({imports:[ze,u.ez,Je,h.S,Ue.S,U.X,ke.EV,Pe.d,v.aw,Z.DL,k.x,Be.W,f.kW,g.hJ,p.u5]})}}return n})()}}]);